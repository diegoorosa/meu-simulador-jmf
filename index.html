<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Abertura de Empresa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-2xl">
        <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <div class="text-center mb-6">
                <!-- A logo será carregada a partir da pasta 'public' -->
                <img src="/JMF-Logo-Open-Graph.png" alt="Logo JMF Contabilidade" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Simulador para Abertura de Empresa</h1>
                <p class="text-gray-600 text-sm sm:text-base mt-2">Preencha os dados abaixo para receber uma análise tributária e nossa proposta.</p>
            </div>
        
            <form id="simulador-form" class="space-y-4">
                <!-- Seus campos de formulário continuam aqui... -->
                 <h2 class="text-lg font-semibold pb-2 border-b border-gray-200 mb-4 text-gray-700">Seus Dados de Contato</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700">Seu nome</label>
                        <input type="text" id="nome" name="nome" placeholder="Ex: João da Silva" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="(47) 99999-8888" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                </div>
                 <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Seu melhor email</label>
                    <input type="email" id="email" name="email" placeholder="Ex: joao.silva@email.com" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
        
                <h2 class="text-lg font-semibold pt-4 pb-2 border-b border-gray-200 mb-4 text-gray-700">Dados da Futura Empresa</h2>
                <div>
                    <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade onde a empresa será sediada</label>
                    <input type="text" id="cidade" name="cidade" placeholder="Ex: Blumenau - SC" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label for="atividade" class="block text-sm font-medium text-gray-700">Atividade principal</label>
                    <input type="text" id="atividade" name="atividade" placeholder="Ex: Desenvolvimento de software" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="socios" class="block text-sm font-medium text-gray-700">Sócios</label>
                        <input type="number" id="socios" name="socios" value="1" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="funcionarios" class="block text-sm font-medium text-gray-700">Funcionários</label>
                        <input type="number" id="funcionarios" name="funcionarios" value="0" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                     <div>
                        <label for="faturamento" class="block text-sm font-medium text-gray-700">Fat. Mensal (R$)</label>
                        <input type="number" id="faturamento" name="faturamento" placeholder="Opcional" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                </div>
                
                <div class="pt-4">
                    <button type="submit" id="analisar-btn" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span id="btn-text">Gerar Análise e Solicitar Proposta</span>
                        <div id="loading" class="hidden w-5 h-5 border-t-2 border-white border-solid rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>

            <div id="loading-view" class="text-center p-8 hidden">
                <div class="mx-auto h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <h3 class="text-xl font-semibold text-gray-800 mt-6">Aguarde, estamos processando sua análise...</h3>
                <p id="loading-message" class="text-gray-600 mt-2">Isso pode levar alguns segundos.</p>
                <p class="text-sm text-gray-500 mt-8">Analisando há <span id="timer">0</span> segundos.</p>
                <p class="font-semibold text-red-600 mt-4">Por favor, não feche ou atualize esta página.</p>
            </div>
            
            <div id="resultado-container" class="mt-6 hidden">
                <div class="mt-6 p-4 bg-green-100 text-green-900 border-l-4 border-green-500 rounded-r-lg">
                    <h3 class="font-bold">Proposta a Caminho!</h3>
                    <p class="mt-2 text-sm">Agradecemos o seu interesse! Nossa equipe já recebeu seus dados e está preparando sua proposta personalizada. <br><br><strong>Você receberá tudo detalhado diretamente no WhatsApp informado dentro de algumas horas.</strong></p>
                </div>
                
                <details class="mt-4" open>
                    <summary class="cursor-pointer text-sm text-blue-600 hover:underline">Ver análise tributária preliminar</summary>
                    <div id="resultado-analise" class="mt-2 p-4 border rounded-md text-gray-700 leading-relaxed text-sm bg-gray-50" style="white-space: pre-wrap;"></div>
                    
                </details>
                <div class="mt-8 text-center">
    <a href="https://api.whatsapp.com/send?phone=554733265123&text=Fiz%20uma%20analise%20no%20simulador%20da%20JMF%20Contabilidade%20e%20quero%20mais%20informa%C3%A7%C3%B5es" 
       target="_blank" 
       rel="noopener noreferrer" 
       class="inline-flex items-center justify-center py-3 px-6 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.001.004 4.971 4.971zm-5.421 2.405s.498-.149.998-.299c.333-.1.75-.213 1.074-.318-1.187.879-2.572 1.394-4.062 1.525l.001.001-3.6-1.22zm10.522-7.221c-.244-.123-1.448-.714-1.674-.795-.225-.082-.39-.123-.555.124-.165.247-.633.795-.775.959-.143.165-.286.186-.531.063-.244-.123-.488-.206-1.074-.418-.751-.278-1.489-.661-2.088-1.221-.521-.488-1.053-1.075-1.053-1.075s-.318-.447-.186-.591c.133-.143.286-.247.447-.351s.225-.225.351-.371c.123-.143.143-.247.206-.418s.021-.308-.043-.43-.555-1.32-.75-1.822c-.186-.488-.371-.418-.531-.418h-.488s-.531.082-.531.555c0 .473.633 1.187 1.448 2.088s1.822 2.333 4.226 3.711c.6.351 1.074.555 1.448.714.531.225 1.074.186 1.448.124.39-.063 1.221-.511 1.448-.959.225-.447.225-.818.165-.959s-.082-.165-.165-.247z" />
        </svg>

        <span>Chamar no WhatsApp Agora</span>
    </a>
</div>
            </div>
        </div>
    </main>

    <script type="module">
        const form = document.getElementById('simulador-form');
        const resultadoContainer = document.getElementById('resultado-container');
        const resultadoAnalise = document.getElementById('resultado-analise');

        // NOVO: Seleciona os elementos da tela de carregamento
        const loadingView = document.getElementById('loading-view');
        const loadingMessage = document.getElementById('loading-message');
        const timerSpan = document.getElementById('timer');

        // NOVO: Variáveis para controlar os timers
        let timerInterval;
        let messageInterval;

        const loadingMessages = [
            "Analisando o regime tributário ideal...",
            "Verificando a natureza jurídica mais adequada...",
            "Cruzando dados com as regras de Santa Catarina...",
            "Compilando os próximos passos para você...",
            "Quase pronto! Finalizando sua análise personalizada..."
        ];

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ALTERADO: Lógica de carregamento
            startLoadingState();

            const formData = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                whatsapp: document.getElementById('whatsapp').value,
                cidade: document.getElementById('cidade').value,
                atividade: document.getElementById('atividade').value,
                socios: document.getElementById('socios').value,
                funcionarios: document.getElementById('funcionarios').value,
                faturamentoMensal: document.getElementById('faturamento').value || '0',
            };

            try {
                const response = await fetch('/api/generate-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido do servidor.');
                }

                const htmlAnalise = marked.parse(result.analise); // Converte Markdown para HTML
                resultadoAnalise.innerHTML = htmlAnalise;        // Exibe o resultado formatado

            } catch (error) {
                console.error('Erro no processo:', error);
                resultadoAnalise.textContent = 'Desculpe, não foi possível processar a análise no momento. Nossa equipe recebeu seus dados e entrará em contato de qualquer forma.';
            } finally {
                // ALTERADO: Lógica para finalizar o carregamento
                stopLoadingState();
            }
        });

        // NOVO: Funções para controlar a tela de carregamento
        function startLoadingState() {
            form.classList.add('hidden');
            loadingView.classList.remove('hidden');

            // Inicia o contador de segundos
            let seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timerSpan.textContent = seconds;
            }, 1000);

            // Inicia a troca de mensagens
            let messageIndex = 0;
            loadingMessage.textContent = loadingMessages[messageIndex];
            messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                loadingMessage.textContent = loadingMessages[messageIndex];
            }, 5000); // Troca a mensagem a cada 5 segundos
        }

        function stopLoadingState() {
            // Para os contadores
            clearInterval(timerInterval);
            clearInterval(messageInterval);

            // Esconde a tela de carregamento e mostra os resultados
            loadingView.classList.add('hidden');
            resultadoContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
